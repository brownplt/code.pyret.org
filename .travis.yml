language: ruby
sudo: required
rvm:
  - 2.6
env:
  secure: "w8CbX+GgOzYhiI4+SkWqX9CDN7k5ME18THDAYF+PnLvMw2dNTLzwGjQ1Mc9SEtaXeX7GehQ9IIDf6n6jawu6xLVc1+rqxDoxQiNhSQpWiTjg/V0YihPk/ZwMh1OZe/spnWvR/x64CL7spiq1pq6XlpGfyKKHIiG72zwYyofwTx7duez4Jx1hBQoTutdv62GkbGYwzWcLTTLE5o/qGE2en7qgAXG3+RZMAQFvof7NpiZJx8dkz/I+2kOxHXrpjLbdLj7JWGij1VWGwiZdMfgYjSLlSAINIt5m3P9P3epuwirfIvATGfO99OyHMdbB5Q0+Qeb7wm7wur2vjNV1gdR15bh1yaYQqJGgbNTjpfuW2xtqaKwugnP/dk91lWNAFAKjdPeGIwLKkBjDIdwawn+y2o+WCETm5oo/ZTwjxGzGsMDLOS53K58W2taS8RpT2VI8H70cyfDvoDJ1AlkdRDSNJdBTd7G9A1Ak4u4jI0pTpdmfhCoXRi26ew+S95epR7aYr9HoAugrfbgbVn7pC9bWnFopNcL1LZUPfXqs2oVZlsURwJOBEOLMDWaP7Uc7PzLh7r4BNW3DI8abcquicc+97uH6NbATzmwRKRt3XMJPDTaXekDIwLMIjYehmt+4veqQGkjWo5ZqWQq8N0coSKcxCFNmpUQLhWf9RcHJzpXe8ig="
script:
- echo "Skipping tests"
#- mocha --harmony
addons:
  chrome: stable
services:
  - xvfb
before_install:
- . $HOME/.nvm/nvm.sh
- nvm install 16.13.0
- nvm use 16.13.0
- npm install -g heroku-cli
- export PATH=$PATH:node_modules/.bin/
install:
- npm update # to update Pyret to the newest version
- npm ci --ignore-scripts
- make web
- make deploy-cpo-main
script:
- echo "No tests on deploy branch"
before_deploy:
- export SHORT_COMMIT=`echo $TRAVIS_COMMIT | cut -c1-7`
- export GIT_REV=`echo $TRAVIS_COMMIT`
- export GIT_BRANCH=`echo $TRAVIS_BRANCH`
- heroku config:set --app code-pyret-org GIT_REV=$GIT_REV
- heroku config:set --app code-pyret-org GIT_BRANCH=$GIT_REV
- heroku config:set --app code-pyret-org CURRENT_PYRET_RELEASE=$SHORT_COMMIT
- heroku config:set --app code-pyret-org PYRET=https://d251z2akfyabv3.cloudfront.net/releases/$SHORT_COMMIT/cpo-main.jarr.gz.js
- rvm $(travis_internal_ruby) --fuzzy do ruby -S gem install faraday -v 1.8.0 # https://travis-ci.community/t/heroku-deploy-fails-installing-dpl-heroku-encounters-faraday-error/12563/2
deploy:
- provider: s3
  access_key_id: AKIAJI5QOXMOMALYEG3Q
  secret_access_key:
    secure: eNHYX/jlPW4ZWOhl3q2XzXaEG0RF3LyNmJ2VULnAocCKfgcSLvrAJalzXZ7wyK7WOBPN9liaLaams0Vq0WqabS09F7TQQYQG0yHx5L2bxkiUmJmMlpku0/Her1/6j+QH7YlLHjHmHF4HNJUgEpp/mwDF4x4/NdQ9H8wGdJSw3OwkE7+27Xg/5OmgKkDOJR/6d9y5Ha8PvVeEt1XC4OMtEn+Himao/X8GUVtrCmnyaACoyuIAS0aYkD5YdpXoluNJW3Iv/aqZOic5zrxx0XCfAneD/bQfCI0LneOICOjLxWkHttjFVTLfzJr4cCB1mFfAAh6fh0BipTVQZze3qp02ziKDJgYPD/Lo6pyuyG+ENwCS/s0jOywpTT4L0MdGUC50eNrrRFpQ5Fch6e2zvdWoj9/eB42VDijP8d+nguwRm/gt/z/6vo4jZaVGdlZaUr4Bx1ejX/30aiw+ezQjPoD2A7tAH7A9qygVAPmvJ7kvYOf+jLzhQUxkQna4lx2BdpirhX/QT8GLoei6LuZ/MQmy79jmlQnR7PUpeVwuN4DK0X5W/0774wPcFhETvr7IpF5DWdZlb8wqg8440abhD2sYBYqpmv9FehdEBSgyFvA2uxIZ7AcBICv47Lz9cvB6rjN1cjAUWRaSB9q54ej18l8o68OZUXe1TY5ek3c+Go2V88k=
  bucket: pyret-releases
  local-dir: build/release
  upload-dir: releases
  acl: public_read
  skip_cleanup: true
  detect_encoding: true
  on:
    repo: brownplt/code.pyret.org
    branch: release
- provider: heroku
  app: code-pyret-org
  api_key:
    secure: "mdGEgMks9Yv6Oq2RuSRGEZ26cj4MgI9KEIf9AloyedYTM9EoFdzg7TVfkLDKjlmpTmi2PLTs9k//F349GnlC3RZr1VZ2OnUXILZG4NEtyleD5t0LxvkhiAjLFUU0EdW3b7fpbNgmO87PSeS9jJIL6uDjgqo8+pcK4y/fj2sRGO0rXOKs3e6aNBhpjMlyhu8LRnLPIIuwRZbby2qTRhC+Lry3uFYvgR94+wk/m1eHj0nxPbMNHxc8mZxL3Uxt6HJ6yhM2OX4mcYigBBe/HBITYphk/kywu84v7Aqq9xt+pR1LOOKELw1sKn2qGrsQ84u/c3q7nc1q6WBVyToZgznPvmOuuIcBHQx3PhxuOYEXJQCXz9Jp948OJ7AIcGt51UpVHmCye9/rIWnN1e9Nj/eDJTqha9DlVhJSbywfen+uTZrFx7boO+qEuiLrtstvm/z/mwAij00qG0AnAoBRrPwZtySTY67LnOMqfQlN7MKtmtdNMJ0jed1G8tqqn2D2km5F/f3DVX/0E1CYbkbLuiMEzvrvz2E6EnYrawVdfJ5HofLOg6y5k4NPzyFPHwrNMgWZ9RZ0fAq61zopPrnIPZz2kkE1jkOoOuE7rdXQunI4UfgdSEQiFutvFZ186EHlvzv0jsD2HSo2W9sKymOKGJwhh5BAiSSvLsXXzccId8gyXPs="
  on:
    repo: brownplt/code.pyret.org
    branch: release
