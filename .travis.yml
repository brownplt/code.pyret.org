language: ruby
sudo: required
rvm:
  - 2.6
env:
  secure: "WH35CQjGMI//kzIT8ePQPiFiEUqN81bFZJdHvKMCELkU/paSEz0sPsJEECuV8T7f/Sy1OEjmGm+C1ywi+Arnq+W8mI08unjFdUtwzDM7uf1lV89+Q/hR5KkCy9w0uFWvIkP7fi1UxP7xjt6/7MO2a5bPepx6VFvzLATg9OPpXXh2jRUENxqXidtsCThzdahpaVTaBXIcaQc7Af7K7u6WJYlI1sTACOc67a5JZeqY8bJBJ9/4Qds14BDfUd+3F6I0PGl66RaSCPOAbBmZohWwAEtmznGB+kZGs7LH/pfRVuZ7oGnHZZh5M+6DkKJMzHkTX3CV8byeQ3JRgeqRCcvH5cfsFcDVgyt+FA1sc/VThtV0yZnHZFN3oGZz74G3oJio2CP6zj7gjuqjvY9qVyucfsj29lhw6qx6LES4lVQWfgtV5H/FLx42o9JWXPaIhdZuLGlc7D30yIKG7hiOQq3nFcgct2gm68jw5VbKr3EkAQO6fpStIOjQJH3cSnILbjzUqvyERUNnEtYSRbD9yC9i/rk02uTBj6y3zPrKxz90xdCaRAyUoTN/a5Iex6C1E3oRWAKMMOCzZR2sebE/dvKgf3TvoqimRNbbLvywUBOnxn53JeXN3uYTXX75Fh9pNxxq1j6dx83iOaMkHp1/gL0evgAxx4DrYXuaFtRy6qDcFFY="
script:
- echo "Skipping tests"
#- mocha --harmony
addons:
  chrome: stable
services:
  - xvfb
before_install:
- . $HOME/.nvm/nvm.sh
- nvm install 16.13.0
- nvm use 16.13.0
- npm install -g heroku-cli
install:
- npm update # to update Pyret to the newest version
- npm ci --ignore-scripts
- make web
- make deploy-cpo-main
script:
- echo "No tests on deploy branch"
before_deploy:
- export SHORT_COMMIT=`echo $TRAVIS_COMMIT | cut -c1-7`
- export GIT_REV=`echo $TRAVIS_COMMIT`
- export GIT_BRANCH=`echo $TRAVIS_BRANCH`
- heroku config:set --app code-pyret-org GIT_REV=$GIT_REV
- heroku config:set --app code-pyret-org GIT_BRANCH=$GIT_REV
- heroku config:set --app code-pyret-org CURRENT_PYRET_RELEASE=$SHORT_COMMIT
- heroku config:set --app code-pyret-org PYRET=https://d251z2akfyabv3.cloudfront.net/releases/$SHORT_COMMIT/cpo-main.jarr.gz.js
- rvm $(travis_internal_ruby) --fuzzy do ruby -S gem install faraday -v 1.8.0 # https://travis-ci.community/t/heroku-deploy-fails-installing-dpl-heroku-encounters-faraday-error/12563/2
deploy:
- provider: s3
  access_key_id: AKIAJI5QOXMOMALYEG3Q
  secret_access_key:
    secure: eNHYX/jlPW4ZWOhl3q2XzXaEG0RF3LyNmJ2VULnAocCKfgcSLvrAJalzXZ7wyK7WOBPN9liaLaams0Vq0WqabS09F7TQQYQG0yHx5L2bxkiUmJmMlpku0/Her1/6j+QH7YlLHjHmHF4HNJUgEpp/mwDF4x4/NdQ9H8wGdJSw3OwkE7+27Xg/5OmgKkDOJR/6d9y5Ha8PvVeEt1XC4OMtEn+Himao/X8GUVtrCmnyaACoyuIAS0aYkD5YdpXoluNJW3Iv/aqZOic5zrxx0XCfAneD/bQfCI0LneOICOjLxWkHttjFVTLfzJr4cCB1mFfAAh6fh0BipTVQZze3qp02ziKDJgYPD/Lo6pyuyG+ENwCS/s0jOywpTT4L0MdGUC50eNrrRFpQ5Fch6e2zvdWoj9/eB42VDijP8d+nguwRm/gt/z/6vo4jZaVGdlZaUr4Bx1ejX/30aiw+ezQjPoD2A7tAH7A9qygVAPmvJ7kvYOf+jLzhQUxkQna4lx2BdpirhX/QT8GLoei6LuZ/MQmy79jmlQnR7PUpeVwuN4DK0X5W/0774wPcFhETvr7IpF5DWdZlb8wqg8440abhD2sYBYqpmv9FehdEBSgyFvA2uxIZ7AcBICv47Lz9cvB6rjN1cjAUWRaSB9q54ej18l8o68OZUXe1TY5ek3c+Go2V88k=
  bucket: pyret-releases
  local-dir: build/release
  upload-dir: releases
  acl: public_read
  skip_cleanup: true
  detect_encoding: true
  on:
    repo: brownplt/code.pyret.org
    branch: release
- provider: heroku
  app: code-pyret-org
  api_key:
    secure: "i0jl8FfQG+k/2tlaE5EWhkaSKAiOwBV2vo0u8Gcbhe6xWDDnwroxmD/m3lAZs7X/v6jtP1nGa8FHw6h4Ag3jqZdf7+AQihdVGi0/FZcOCB2Fi69VcAFG/XbD2lfsd6wuWf6PQcrGhRXNrlFuu97foAvmzYa34JFJndW9ONpni2RkfACU+kKoswBTTEJyCjtPW0JvlVu+2FCQeHYCFEv/al4hq7XSUJpIOKocPCxM4qcPGINQhj7Isu2v9v/f951gwHHlz2b06KsjXVlDfGtOc7z5pXJPXBVBSMcYFwrb14JPXTZgoRmmjpoeXyR4skFAHTgkFDtDWl/aNnaJNk4twl32vrXIH49O9PZHv/fcXgZ6Lk0iUPSM3HUsJI3aM1X4/slTLTTeuR5/bpw8d4UVdQiYgeK223Vc00BFuupJWwitJr59RH3tJdrZNpZ95LnkEubDB/QgHRUXHpmg8oIcP8t0eBXRbWwDzsWJLreP9gIUANNvHcFFUQVtsobBwCeuUL24raurXtFMsKP+L+FmsbwdMRSZMznRAzJtw2Tr1Ncp2UEjPn/XwmmnC4FIUZB1HxJPooMZTxg3OZJOKwQf6NWHNQ25yBhL0066SxbTYIskwJZtw00xSwWOQXbJOXalJy43EYEbjccTSCbKpdZrzWzsHlF8uVSyfwiWEoafeRo="
  on:
    repo: brownplt/code.pyret.org
    branch: release
